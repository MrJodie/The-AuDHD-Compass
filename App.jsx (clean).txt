import React, { useState, useEffect, useCallback, useMemo } from "react";
import { createRoot } from 'react-dom/client';
import { initializeApp, setLogLevel } from "firebase/app";
import { 
    getAuth, 
    signInAnonymously, 
    signInWithCustomToken, 
    onAuthStateChanged 
} from "firebase/auth";
import { 
    getFirestore, 
    collection, 
    query, 
    onSnapshot, 
    doc, 
    addDoc, 
    updateDoc, 
    deleteDoc, 
    where, 
    getDocs, 
    runTransaction, 
    serverTimestamp 
} from "firebase/firestore";

// --- GLOBAL VARIABLES (Provided by the Canvas Environment) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- CONSTANTS ---
const tabs = ['Discussions', 'Chat', 'Wiki'];
const DISCUSSION_CATEGORIES = [
    'Executive Functioning Hacks',
    'Sensory & Meltdown Management',
    'Medications & Treatments',
    'Late Diagnosis & Identity',
    'Social & Masking Strategies',
    'Hyperfixations & Special Interests',
    'Family & Relationships',
    'Scientific Research & News',
    'Emotional Regulation',
];

// --- COMPONENTS START ---
const useFirebase = () => {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [appInitialized, setAppInitialized] = useState(false);

    useEffect(() => {
        if (!appInitialized && Object.keys(firebaseConfig).length > 0) {
            try {
                setLogLevel('debug');
                const app = initializeApp(firebaseConfig);
                const authInstance = getAuth(app);
                const dbInstance = getFirestore(app);

                setAuth(authInstance);
                setDb(dbInstance);

                const attemptSignIn = async () => {
                    let user = null;
                    
                    if (initialAuthToken) {
                        try {
                            const userCredential = await signInWithCustomToken(authInstance, initialAuthToken);
                            user = userCredential.user;
                            console.log("Firebase: Signed in with Custom Token.");
                        } catch (error) {
                            console.error("Firebase: Custom token sign-in failed. Falling back to anonymous.", error);
                        }
                    }

                    if (!user) {
                        try {
                            const userCredential = await signInAnonymously(authInstance);
                            user = userCredential.user;
                            console.log("Firebase: Signed in anonymously.");
                        } catch (error) {
                            console.error("Firebase: Anonymous sign-in failed.", error);
                        }
                    }

                    onAuthStateChanged(authInstance, (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            setUserId(null); 
                        }
                        setIsAuthReady(true);
                    });
                };

                attemptSignIn();
                setAppInitialized(true);

            } catch (e) {
                console.error("Firebase initialization error:", e);
                setIsAuthReady(true);
            }
        }
    }, [appInitialized]);

    return { db, auth, userId, isAuthReady };
};
const CommentRenderer = React.memo(({ comment, allComments, db, userId, threadId }) => {
    const isOwner = comment.userId === userId;
    const [replyText, setReplyText] = useState('');
    const [showReplyForm, setShowReplyForm] = useState(false);

    const handlePostReply = async () => {
        if (!replyText.trim() || !threadId || !userId) return;

        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/community_threads/${threadId}/comments`), {
                content: replyText.trim(),
                userId: userId,
                timestamp: serverTimestamp(),
                parentId: comment.id,
            });
            setReplyText('');
            setShowReplyForm(false);
        } catch (error) {
            console.error("Error posting reply:", error);
        }
    };

    const childComments = allComments.filter(c => c.parentId === comment.id);

    return (
        <div className="mt-2 pl-4 border-l-2 border-indigo-200">
            <div className={`p-3 rounded-lg shadow-sm ${isOwner ? 'bg-indigo-50 border border-indigo-300' : 'bg-white border border-gray-200'}`}>
                <p className="text-sm font-medium text-gray-800 break-words">{comment.content}</p>
                <div className="text-xs text-gray-500 mt-2 flex justify-between items-center">
                    <span className="font-mono text-xs">User: {comment.userId.substring(0, 8)}...</span>
                    <button 
                        onClick={() => setShowReplyForm(!showReplyForm)}
                        className="text-indigo-600 hover:text-indigo-800 font-semibold transition duration-150"
                    >
                        {showReplyForm ? 'Cancel Reply' : 'Reply'}
                    </button>
                </div>
            </div>

            {showReplyForm && (
                <div className="mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                    <textarea
                        value={replyText}
                        onChange={(e) => setReplyText(e.target.value)}
                        placeholder={`Replying to ${comment.userId.substring(0, 8)}...`}
                        rows="3"
                        className="w-full p-2 text-sm border border-indigo-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                    ></textarea>
                    <button
                        onClick={handlePostReply}
                        className="mt-2 w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition duration-200 shadow-md"
                    >
                        Post Reply
                    </button>
                </div>
            )}

            {childComments.length > 0 && (
                <div className="mt-4 space-y-2">
                    {childComments.sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis()).map(child => (
                        <CommentRenderer 
                            key={child.id} 
                            comment={child} 
                            allComments={allComments} 
                            db={db} 
                            userId={userId} 
                            threadId={threadId}
                        />
                    ))}
                </div>
            )}
        </div>
    );
});
const Discussions = ({ db, userId }) => {
    const [selectedCategory, setSelectedCategory] = useState(DISCUSSION_CATEGORIES[0]);
    const [threads, setThreads] = useState([]);
    const [allComments, setAllComments] = useState({});
    const [showNewThreadModal, setShowNewThreadModal] = useState(false);
    const [newTitle, setNewTitle] = useState('');
    const [newContent, setNewContent] = useState('');
    const [selectedThread, setSelectedThread] = useState(null);

    useEffect(() => {
        if (!db) return;

        const threadsRef = collection(db, `artifacts/${appId}/public/data/community_threads`);
        const q = query(threadsRef, where('category', '==', selectedCategory));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedThreads = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate() || new Date()
            }));
            setThreads(fetchedThreads.sort((a, b) => b.timestamp - a.timestamp));
        }, (error) => {
            console.error("Error fetching threads:", error);
        });

        return () => unsubscribe();
    }, [db, selectedCategory]);

    useEffect(() => {
        if (!db || !selectedThread) return;

        const commentsRef = collection(db, `artifacts/${appId}/public/data/community_threads/${selectedThread.id}/comments`);

        const unsubscribeComments = onSnapshot(commentsRef, (snapshot) => {
            const fetchedComments = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate() || new Date()
            }));
            setAllComments(fetchedComments);
        }, (error) => {
            console.error("Error fetching comments:", error);
        });

        return () => unsubscribeComments();
    }, [db, selectedThread]);
    const handleNewThread = async () => {
        if (!newTitle.trim() || !newContent.trim() || !userId) return;

        try {
            const threadsRef = collection(db, `artifacts/${appId}/public/data/community_threads`);
            await addDoc(threadsRef, {
                title: newTitle.trim(),
                content: newContent.trim(),
                category: selectedCategory,
                userId: userId,
                timestamp: serverTimestamp(),
                replyCount: 0,
            });

            setNewTitle('');
            setNewContent('');
            setShowNewThreadModal(false);
        } catch (error) {
            console.error("Error creating new thread:", error);
        }
    };

    const handleCommentPost = async (threadId, content) => {
        if (!content.trim() || !threadId || !userId) return;

        try {
            const commentsRef = collection(db, `artifacts/${appId}/public/data/community_threads/${threadId}/comments`);
            await addDoc(commentsRef, {
                content: content.trim(),
                userId: userId,
                timestamp: serverTimestamp(),
                parentId: null,
            });
        } catch (error) {
            console.error("Error posting comment:", error);
        }
    };

    if (selectedThread) {
        const topLevelComments = allComments
            .filter(c => !c.parentId)
            .sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());

        return (
            <div className="p-4 bg-gray-50 min-h-[70vh]">
                <button
                    onClick={() => setSelectedThread(null)}
                    className="mb-4 text-indigo-600 hover:text-indigo-800 flex items-center transition duration-150"
                >
                    &larr; Back to {selectedCategory}
                </button>

                <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 className="text-3xl font-bold text-gray-900 mb-2">{selectedThread.title}</h2>
                    <p className="text-sm text-gray-500 mb-4">
                        Posted by <span className="font-mono text-indigo-600">{selectedThread.userId.substring(0, 8)}...</span> on {selectedThread.timestamp?.toLocaleDateString()}
                    </p>
                    <div className="prose max-w-none text-gray-700 border-l-4 border-indigo-400 pl-4 py-2 bg-indigo-50/50 rounded-md">
                        <p className="whitespace-pre-wrap">{selectedThread.content}</p>
                    </div>
                </div>

                <div className="mt-8">
                    <h3 className="text-xl font-semibold text-gray-800 mb-3">Add a Comment</h3>
                    <div className="bg-white p-4 rounded-xl shadow-md border border-gray-200">
                        <textarea
                            id="newComment"
                            rows="4"
                            placeholder="Share your thoughts, experiences, or resources..."
                            className="w-full p-3 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                        ></textarea>
                        <button
                            onClick={() => handleCommentPost(selectedThread.id, document.getElementById('newComment').value)}
                            className="mt-3 bg-indigo-600 text-white py-2 px-4 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition duration-200 shadow-md"
                        >
                            Post Comment
                        </button>
                    </div>
                </div>
                {/* Comments Section */}
                <div className="mt-10">
                    <h3 className="text-xl font-semibold text-gray-800 mb-4">{allComments.length} {allComments.length === 1 ? 'Response' : 'Responses'}</h3>
                    <div className="space-y-4">
                        {topLevelComments.length > 0 ? (
                            topLevelComments.map(comment => (
                                <CommentRenderer
                                    key={comment.id}
                                    comment={comment}
                                    allComments={allComments}
                                    db={db}
                                    userId={userId}
                                    threadId={selectedThread.id}
                                />
                            ))
                        ) : (
                            <p className="text-gray-500 italic">Be the first to respond to this discussion!</p>
                        )}
                    </div>
                </div>
            </div>
        );
    }


    // Render the Thread List
    return (
        <div className="p-4 flex">
            {/* Left Rail: Categories */}
            <div className="w-1/4 pr-4 border-r border-gray-200">
                <h3 className="text-lg font-bold mb-4 text-gray-800">Categories</h3>
                <div className="space-y-2">
                    {DISCUSSION_CATEGORIES.map(category => (
                        <button
                            key={category}
                            onClick={() => { setSelectedCategory(category); setSelectedThread(null); }}
                            className={`block w-full text-left p-2 rounded-lg transition duration-150 ${
                                selectedCategory === category 
                                    ? 'bg-indigo-600 text-white font-semibold shadow-md' 
                                    : 'bg-white text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 border border-gray-200'
                            }`}
                        >
                            {category}
                        </button>
                    ))}
                </div>
            </div>

            {/* Right Panel: Thread List */}
            <div className="w-3/4 pl-6">
                <div className="flex justify-between items-center mb-6">
                    <h2 className="text-2xl font-bold text-gray-900">{selectedCategory} Discussions</h2>
                    <button
                        onClick={() => { 
                            setNewTitle(''); 
                            setNewContent('');
                            setShowNewThreadModal(true); 
                        }}
                        className="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-lg"
                    >
                        + Start New Thread
                    </button>
                </div>

                {/* Thread List */}
                <div className="space-y-4">
                    {threads.length > 0 ? (
                        threads.map(thread => (
                            <div 
                                key={thread.id} 
                                onClick={() => setSelectedThread(thread)}
                                className="bg-white p-4 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition duration-200 cursor-pointer"
                            >
                                <h3 className="text-xl font-semibold text-indigo-700">{thread.title}</h3>
                                <p className="text-sm text-gray-600 mt-1 line-clamp-2">{thread.content}</p>
                                <div className="mt-3 flex justify-between text-xs text-gray-500">
                                    <span>
                                        Posted by <span className="font-mono">{thread.userId.substring(0, 8)}...</span>
                                    </span>
                                    <span>
                                        {allComments.length} Responses &bull; {thread.timestamp?.toLocaleString()}
                                    </span>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center p-8 bg-white rounded-xl shadow-md">
                            <p className="text-lg text-gray-500 italic">No threads found in this category. Be the first to start a discussion!</p>
                        </div>
                    )}
                </div>


                {/* New Thread Modal */}
                {showNewThreadModal && (
                    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
                            <h3 className="text-2xl font-bold text-gray-900 mb-4">Start New Discussion Thread</h3>
                            <p className="text-sm text-gray-600 mb-4">Posting in category: <span className="font-semibold text-indigo-600">{selectedCategory}</span></p>
                            
                            <input
                                type="text"
                                placeholder="Thread Title (Be clear and specific)"
                                value={newTitle}
                                onChange={(e) => setNewTitle(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500"
                            />
                            
                            <textarea
                                placeholder="Your main post content (Advice, question, resource share...)"
                                rows="6"
                                value={newContent}
                                onChange={(e) => setNewContent(e.target.value)}
                                className="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                            ></textarea>

                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={() => setShowNewThreadModal(false)}
                                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleNewThread}
                                    className="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200"
                                >
                                    Post to {selectedCategory}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// 3. Chat Tab Content (Real-time group chat)
const Chat = ({ db, userId }) => {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const messagesEndRef = React.useRef(null);

    // Scroll to the bottom of the chat list
    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    };

    // Fetch messages on load and listen for real-time updates
    useEffect(() => {
        if (!db) return;

        const chatRef = collection(db, `artifacts/${appId}/public/data/chat`);
        const q = query(chatRef, where('timestamp', '!=', null));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedMessages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                timestamp: doc.data().timestamp?.toDate() || new Date()
            }));
            fetchedMessages.sort((a, b) => a.timestamp - b.timestamp);
            setMessages(fetchedMessages);
            scrollToBottom();
        }, (error) => {
            console.error("Error fetching chat messages:", error);
        });

        return () => unsubscribe();
    }, [db]);

    // Scroll after messages are loaded/updated
    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    const handleSendMessage = async () => {
        if (!newMessage.trim() || !userId) return;

        try {
            await addDoc(collection(db, `artifacts/${appId}/public/data/chat`), {
                content: newMessage.trim(),
                userId: userId,
                timestamp: serverTimestamp(),
            });
            setNewMessage('');
        } catch (error) {
            console.error("Error sending message:", error);
        }
    };

    return (
        <div className="flex flex-col h-[70vh] bg-gray-50 border-t border-gray-200">
            {/* Message List */}
            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                <h3 className="text-xl font-bold text-gray-800 border-b pb-2 mb-4 sticky top-0 bg-gray-50 z-10">Live Group Chat</h3>
                {messages.slice(-100).map(msg => (
                    <div key={msg.id} className={`flex ${msg.userId === userId ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-xs lg:max-w-md p-3 rounded-xl shadow-md ${
                            msg.userId === userId
                                ? 'bg-indigo-600 text-white rounded-br-none'
                                : 'bg-white text-gray-800 rounded-tl-none border border-gray-200'
                        }`}>
                            <div className={`text-xs mb-1 ${msg.userId === userId ? 'text-indigo-200' : 'text-gray-500'}`}>
                                <span className="font-mono">{msg.userId.substring(0, 8)}...</span>
                                <span className="ml-2 text-xs opacity-75">{msg.timestamp?.toLocaleTimeString()}</span>
                            </div>
                            <p className="break-words">{msg.content}</p>
                        </div>
                    </div>
                ))}
                <div ref={messagesEndRef} />
            </div>

            {/* Input Area */}
            <div className="p-4 bg-white border-t border-gray-200 shadow-xl">
                <div className="flex space-x-3">
                    <input
                        type="text"
                        value={newMessage}
                        onChange={(e) => setNewMessage(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleSendMessage()}
                        placeholder="Type a message..."
                        className="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    />
                    <button
                        onClick={handleSendMessage}
                        className="bg-indigo-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md disabled:bg-indigo-400"
                        disabled={!newMessage.trim()}
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
    );
};

// 4. Wiki Tab Content (Collaborative Knowledge Base)
const Wiki = ({ db, userId }) => {
    const [pages, setPages] = useState([]);
    const [currentPage, setCurrentPage] = useState(null);
    const [isEditing, setIsEditing] = useState(false);
    const [editTitle, setEditTitle] = useState('');
    const [editContent, setEditContent] = useState('');

    const wikiCollectionRef = collection(db, `artifacts/${appId}/public/data/wiki`);

    // Fetch all Wiki Page Titles (minimal fetch)
    useEffect(() => {
        if (!db) return;

        const q = query(wikiCollectionRef, where('title', '!=', null));
        
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const fetchedPages = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data(),
                lastUpdated: doc.data().lastUpdated?.toDate() || new Date()
            }));
            setPages(fetchedPages.sort((a, b) => a.title.localeCompare(b.title)));
        }, (error) => {
            console.error("Error fetching wiki pages:", error);
        });

        return () => unsubscribe();
    }, [db]);

    // Load content when a page is selected or switch to editing mode
    useEffect(() => {
        if (currentPage && !isEditing) {
            setEditTitle(currentPage.title);
            setEditContent(currentPage.content || '');
        }
    }, [currentPage, isEditing]);

    // Handlers
    const handleViewPage = (page) => {
        setCurrentPage(page);
        setIsEditing(false);
    };

    const handleSave = async () => {
        if (!editTitle.trim() || !editContent.trim() || !userId) return;

        const data = {
            title: editTitle.trim(),
            content: editContent.trim(),
            lastUpdated: serverTimestamp(),
            lastEditorId: userId,
        };

        try {
            if (currentPage && currentPage.id) {
                await updateDoc(doc(wikiCollectionRef, currentPage.id), data);
                setCurrentPage({ ...currentPage, ...data });
                console.log("Wiki page updated successfully.");
            } else {
                const newDocRef = await addDoc(wikiCollectionRef, data);
                setCurrentPage({ id: newDocRef.id, ...data });
                console.log("New Wiki page created successfully.");
            }
            setIsEditing(false);
        } catch (error) {
            console.error("Error saving wiki page:", error);
        }
    };
    
    const handleNewPage = () => {
        setCurrentPage(null);
        setEditTitle('');
        setEditContent('');
        setIsEditing(true);
    };
    const renderWikiContent = () => {
        if (isEditing) {
            return (
                <div className="p-6 bg-white rounded-xl shadow-lg border border-indigo-200">
                    <h3 className="text-2xl font-bold text-gray-900 mb-4">{currentPage ? 'Edit Page' : 'Create New Page'}</h3>
                    <input
                        type="text"
                        placeholder="Page Title (e.g., Sensory Tools for the Office)"
                        value={editTitle}
                        onChange={(e) => setEditTitle(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg mb-4 text-xl font-semibold focus:ring-indigo-500 focus:border-indigo-500"
                    />
                    <textarea
                        placeholder="Write the collaborative entry here. Share resources, tips, and definitions."
                        rows="15"
                        value={editContent}
                        onChange={(e) => setEditContent(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg mb-6 focus:ring-indigo-500 focus:border-indigo-500 resize-none"
                    ></textarea>
                    <div className="flex justify-end space-x-3">
                        <button
                            onClick={() => setIsEditing(false)}
                            className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150"
                        >
                            Cancel
                        </button>
                        <button
                            onClick={handleSave}
                            className="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200"
                            disabled={!editTitle.trim() || !editContent.trim()}
                        >
                            Save & Publish
                        </button>
                    </div>
                </div>
            );
        }

        if (currentPage) {
            return (
                <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h2 className="text-3xl font-bold text-gray-900 mb-2">{currentPage.title}</h2>
                    <div className="text-sm text-gray-500 mb-4 flex justify-between">
                        <span>Last Updated: {currentPage.lastUpdated?.toLocaleString() || 'Saving...'}</span>
                        <span className="font-mono">Editor: {currentPage.lastEditorId?.substring(0, 8) || 'Unknown'}...</span>
                    </div>
                    
                    <div className="prose max-w-none text-gray-700 whitespace-pre-wrap border-t pt-4">
                        {currentPage.content}
                    </div>

                    <button
                        onClick={() => setIsEditing(true)}
                        className="mt-6 bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md"
                    >
                        Edit This Page
                    </button>
                </div>
            );
        }

        return (
            <div className="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Select a Wiki Topic</h2>
                <p className="text-gray-600 mb-6">The Wiki is a collaborative, community-sourced knowledge base for AuDHD resources and strategies.</p>
                <button
                    onClick={handleNewPage}
                    className="bg-green-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md"
                >
                    + Create New Page
                </button>
                <p className="text-lg font-semibold text-gray-800 mt-8 mb-4 border-b pb-2">Existing Pages ({pages.length})</p>
                <ul className="space-y-2">
                    {pages.map(page => (
                        <li 
                            key={page.id}
                            onClick={() => handleViewPage(page)}
                            className="cursor-pointer text-indigo-700 hover:text-indigo-900 font-medium transition duration-150 p-2 rounded-lg hover:bg-indigo-50 flex justify-between items-center border border-transparent hover:border-indigo-100"
                        >
                            {page.title}
                            <span className="text-xs text-gray-500">
                                Last updated: {page.lastUpdated?.toLocaleDateString()}
                            </span>
                        </li>
                    ))}
                </ul>
            </div>
        );
    };

    return (
        <div className="p-4 flex">
            {/* Left Rail (Optional Sidebar for categories if needed later) */}
            <div className="w-1/4 pr-4 hidden lg:block">
                {/* Reserved for future Wiki categories */}
            </div>

            {/* Main Wiki Content Area */}
            <div className="w-full lg:w-3/4">
                {renderWikiContent()}
            </div>
        </div>
    );
};
// 5. Main App Component
const App = () => {
    const [activeTab, setActiveTab] = useState('Discussions');
    const { db, userId, isAuthReady } = useFirebase();

    const renderContent = () => {
        if (!isAuthReady) {
            return (
                <div className="flex justify-center items-center h-full text-lg text-indigo-600">
                    <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Connecting to AuDHD Compass Backend...
                </div>
            );
        }

        if (!db || !userId) {
            return (
                <div className="flex justify-center items-center h-full p-8 text-center bg-red-50 text-red-800 border-red-300 border rounded-xl">
                    <p className="font-semibold">
                        Connection Error: Could not initialize Firebase or retrieve User ID. 
                        Please ensure `__firebase_config` is valid JSON and that the security rules are published.
                    </p>
                </div>
            );
        }

        switch (activeTab) {
            case 'Discussions':
                return <Discussions db={db} userId={userId} />;
            case 'Chat':
                return <Chat db={db} userId={userId} />;
            case 'Wiki':
                return <Wiki db={db} userId={userId} />;
            default:
                return null;
        }
    };

const container = document.getElementById('root');
const root = createRoot(container);
root.render(<App />);
undefined
